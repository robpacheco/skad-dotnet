using System.Collections.Generic;
using System.Runtime.InteropServices.ComTypes;
using Skad.Common.Api.Common;
using Skad.Common.Http;

namespace Skad.VulnFeed.MvcControllers.ViewModels
{
    public class VulnerabilityFeedIndexModel
    {
        private readonly LinkGenerator _linkGenerator;
        private readonly PageInfo _pageInfo;

        public IEnumerable<VulnerabilityFeedItem> Items { get; }

        public string SubscriptionLink()
        {
            return _linkGenerator.GenerateSubscriptionUri("subscription").ToString();
        }
        
        public bool HasPrevPage => _pageInfo.HasPrevPage;

        public string? PrevPageLink
        {
            get
            {
                if (_pageInfo.HasPrevPage)
                {
                    var vulnFeedUrl = _linkGenerator.GenerateVulnerabilityFeedUri("vulnerability-feed").ToString();
                    return $"{vulnFeedUrl}?{_pageInfo.PrevPageQueryParameters}";
                }

                return null;
            }
        }

        public bool HasNextPage => _pageInfo.HasNextPage;
        
        public string? NextPageLink
        {
            get
            {
                if (_pageInfo.HasNextPage)
                {
                    var vulnFeedUrl = _linkGenerator.GenerateVulnerabilityFeedUri("vulnerability-feed").ToString();
                    return $"{vulnFeedUrl}?{_pageInfo.NextPageQueryParameters}";
                }

                return null;
            }
        }

        public VulnerabilityFeedIndexModel(LinkGenerator linkGenerator, IEnumerable<VulnerabilityFeedItem> items, PageInfo pageInfo)
        {
            Items = items;
            _linkGenerator = linkGenerator;
            _pageInfo = pageInfo;
        }
    }

    public class VulnerabilityFeedItem
    {
        public VulnerabilityFeedItem(string cveId, decimal? scoreCvssV2, string? severityCvssV2, decimal? scoreCvssV3, string? severityCvssV3)
        {
            CveId = cveId;
            AffectedComponent = "[Unspecified]";
            AffectedVersions = "";
            ScoreCvssV2 = scoreCvssV2;
            SeverityCvssV2 = severityCvssV2;
            ScoreCvssV3 = scoreCvssV3;
            SeverityCvssV3 = severityCvssV3;
        }

        public VulnerabilityFeedItem(string cveId, string affectedComponent, string affectedVersions, decimal? scoreCvssV2, string? severityCvssV2, decimal? scoreCvssV3, string? severityCvssV3)
        {
            CveId = cveId;
            AffectedComponent = affectedComponent;
            AffectedVersions = affectedVersions;
            ScoreCvssV2 = scoreCvssV2;
            SeverityCvssV2 = severityCvssV2;
            ScoreCvssV3 = scoreCvssV3;
            SeverityCvssV3 = severityCvssV3;
        }

        public string CveId { get; set; }
        public string AffectedComponent { get; set; }
        public string AffectedVersions { get; set; }
        public decimal? ScoreCvssV2 { get; set; }
        public string? SeverityCvssV2 { get; set; }
        public decimal? ScoreCvssV3 { get; set; }
        public string? SeverityCvssV3 { get; set; }
    }
}