using System;
using System.Threading.Tasks;
using Grpc.Net.Client;
using Microsoft.Extensions.Options;
using Skad.VulnFeed.Grpc.Settings;

namespace Skad.VulnFeed.Grpc.Clients;

public class SubscriptionGrpcClient : ISubscriptionGrpcClient
{
    private readonly SubscriptionClientSettings _clientSettings;

    public SubscriptionGrpcClient(IOptions<SubscriptionClientSettings> clientSettings)
    {
        _clientSettings = clientSettings.Value ?? throw new ArgumentNullException(nameof(clientSettings));
    }

    public async Task<SubscriptionReply> GetCurrentSubscription()
    {
        using var channel = GrpcChannel.ForAddress(_clientSettings.ClientUrl);
        var subClient = new Subscription.SubscriptionClient(channel);
        var subReply = await subClient.GetActiveSubscriptionAsync(new SubscriptionRequest { });

        return subReply;
    }
}